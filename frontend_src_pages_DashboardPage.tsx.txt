import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';
import { LogOut, Wallet, History, Smartphone } from 'lucide-react';

interface User {
  id: string;
  name: string;
  email: string;
  phone: string;
  wallet_balance: number;
}

interface Transaction {
  id: string;
  amount: number;
  network: string;
  bundle: string;
  status: string;
  created_at: string;
}

export default function DashboardPage() {
  const [user, setUser] = useState<User | null>(null);
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [selectedNetwork, setSelectedNetwork] = useState('MTN');
  const [selectedAmount, setSelectedAmount] = useState('500');
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  useEffect(() => {
    fetchUserData();
    fetchTransactions();
  }, []);

  const fetchUserData = async () => {
    try {
      const token = localStorage.getItem('authToken');
      const response = await axios.get(`${process.env.REACT_APP_API_URL}/api/user/profile`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      setUser(response.data);
    } catch (err) {
      console.error('Failed to fetch user data');
    }
  };

  const fetchTransactions = async () => {
    try {
      const token = localStorage.getItem('authToken');
      const response = await axios.get(`${process.env.REACT_APP_API_URL}/api/transactions`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      setTransactions(response.data);
    } catch (err) {
      console.error('Failed to fetch transactions');
    }
  };

  const handleBuyBundle = async () => {
    setLoading(true);
    try {
      const token = localStorage.getItem('authToken');
      const response = await axios.post(
        `${process.env.REACT_APP_API_URL}/api/bundles/purchase`,
        { network: selectedNetwork, amount: parseInt(selectedAmount) },
        { headers: { Authorization: `Bearer ${token}` } }
      );
      
      alert('Bundle purchased successfully!');
      fetchUserData();
      fetchTransactions();
    } catch (err: any) {
      alert(err.response?.data?.message || 'Failed to purchase bundle');
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userRole');
    navigate('/');
  };

  if (!user) return <div className="text-center py-12">Loading...</div>;

  return (
    <div className="max-w-6xl mx-auto py-12 px-4">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Dashboard</h1>
        <button
          onClick={handleLogout}
          className="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
        >
          <LogOut className="w-4 h-4" /> Logout
        </button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        {/* User Card */}
        <div className="bg-white p-6 rounded-lg shadow-md">
          <h2 className="text-xl font-bold mb-2">Profile</h2>
          <p className="text-gray-600">Name: {user.name}</p>
          <p className="text-gray-600">Email: {user.email}</p>
          <p className="text-gray-600">Phone: {user.phone}</p>
        </div>

        {/* Wallet Card */}
        <div className="bg-blue-600 text-white p-6 rounded-lg shadow-md">
          <div className="flex items-center gap-2 mb-2">
            <Wallet className="w-6 h-6" />
            <h2 className="text-xl font-bold">Wallet Balance</h2>
          </div>
          <p className="text-4xl font-bold">₦{user.wallet_balance.toLocaleString()}</p>
        </div>

        {/* Stats Card */}
        <div className="bg-white p-6 rounded-lg shadow-md">
          <h2 className="text-xl font-bold mb-2">Statistics</h2>
          <p className="text-gray-600">Total Transactions: {transactions.length}</p>
          <p className="text-gray-600">Last Updated: {new Date().toLocaleDateString()}</p>
        </div>
      </div>

      {/* Buy Bundle Section */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
          <Smartphone className="w-6 h-6" /> Buy Data Bundle
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-gray-700 font-bold mb-2">Select Network</label>
            <select
              value={selectedNetwork}
              onChange={(e) => setSelectedNetwork(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            >
              <option>MTN</option>
              <option>Airtel</option>
              <option>Glo</option>
              <option>Jio</option>
            </select>
          </div>

          <div>
            <label className="block text-gray-700 font-bold mb-2">Select Amount</label>
            <select
              value={selectedAmount}
              onChange={(e) => setSelectedAmount(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            >
              <option value="500">₦500 - 1GB</option>
              <option value="1000">₦1,000 - 2GB</option>
              <option value="2000">₦2,000 - 5GB</option>
              <option value="5000">₦5,000 - 10GB</option>
            </select>
          </div>

          <div className="flex items-end">
            <button
              onClick={handleBuyBundle}
              disabled={loading}
              className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition disabled:opacity-50"
            >
              {loading ? 'Processing...' : 'Buy Now'}
            </button>
          </div>
        </div>
      </div>

      {/* Transaction History */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
          <History className="w-6 h-6" /> Transaction History
        </h2>
        
        {transactions.length === 0 ? (
          <p className="text-gray-600">No transactions yet</p>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="border-b border-gray-300">
                  <th className="text-left py-2 px-4">Network</th>
                  <th className="text-left py-2 px-4">Amount</th>
                  <th className="text-left py-2 px-4">Bundle</th>
                  <th className="text-left py-2 px-4">Status</th>
                  <th className="text-left py-2 px-4">Date</th>
                </tr>
              </thead>
              <tbody>
                {transactions.map(tx => (
                  <tr key={tx.id} className="border-b border-gray-200">
                    <td className="py-2 px-4">{tx.network}</td>
                    <td className="py-2 px-4">₦{tx.amount}</td>
                    <td className="py-2 px-4">{tx.bundle}</td>
                    <td className="py-2 px-4">
                      <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                        tx.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                      }`}>
                        {tx.status}
                      </span>
                    </td>
                    <td className="py-2 px-4">{new Date(tx.created_at).toLocaleDateString()}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}